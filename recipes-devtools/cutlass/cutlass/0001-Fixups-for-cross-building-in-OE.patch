From c8ee209b707475541337a5bd0a30b9a4d016f69e Mon Sep 17 00:00:00 2001
From: Ilies CHERGUI <ichergui@nvidia.com>
Date: Fri, 14 Nov 2025 15:34:20 +0000
Subject: [PATCH] Fixups for cross building in OE

Upstream-Status: Inappropriate [OE-specific]
Signed-off-by: Ilies CHERGUI <ichergui@nvidia.com>
---
 CMakeLists.txt                                | 28 -------------------
 cmake/googletest.cmake                        | 25 +----------------
 .../CMakeLists.txt                            |  3 ++
 include/cutlass/platform/platform.h           | 10 +++----
 python/cutlass/emit/pytorch.py                |  5 ----
 5 files changed, 9 insertions(+), 62 deletions(-)

diff --git a/CMakeLists.txt b/CMakeLists.txt
index b54b8335..3bfc89fa 100755
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -163,21 +163,6 @@ set(CUTLASS_ENABLE_SELF_CONTAINED_INCLUDES_CHECK ON CACHE BOOL "Enable CUTLASS c
 
 ################################################################################
 
-set(CUTLASS_NVCC_ARCHS_SUPPORTED "")
-if (CUDA_VERSION VERSION_GREATER_EQUAL 11.4)
-  list(APPEND CUTLASS_NVCC_ARCHS_SUPPORTED 70 72 75 80 86 87)
-endif()
-if (CUDA_VERSION VERSION_GREATER_EQUAL 11.8)
-  list(APPEND CUTLASS_NVCC_ARCHS_SUPPORTED 89 90)
-endif()
-if (CUDA_VERSION VERSION_GREATER_EQUAL 12.0)
-  list(APPEND CUTLASS_NVCC_ARCHS_SUPPORTED 90a)
-endif()
-
-if (CUDA_VERSION VERSION_GREATER_EQUAL 12.8)
-  list(APPEND CUTLASS_NVCC_ARCHS_SUPPORTED 100 100a 101 101a 120 120a)
-endif()
-
 set(CUTLASS_NVCC_ARCHS ${CUTLASS_NVCC_ARCHS_SUPPORTED} CACHE STRING "The SM architectures requested.")
 set(CUTLASS_NVCC_ARCHS_ENABLED ${CUTLASS_NVCC_ARCHS} CACHE STRING "The SM architectures to build code for.")
 
@@ -756,19 +741,6 @@ if (DOXYGEN_FOUND)
     )
 endif()
 
-if(NOT WIN32)
-  # Add common library search paths so executables and libraries can load and run
-  # without LD_LIBRARY_PATH being set.
-  link_libraries(
-    "-Wl,-rpath,'$ORIGIN'"
-    "-Wl,-rpath,'$ORIGIN/../lib64'"
-    "-Wl,-rpath,'$ORIGIN/../lib'"
-    "-Wl,-rpath,'${CUDA_TOOLKIT_ROOT_DIR}/lib64'"
-    "-Wl,-rpath,'${CUDA_TOOLKIT_ROOT_DIR}/lib'"
-    ${CMAKE_DL_LIBS}
-    )
-endif()
-
 ################################################################################
 
 include(CTest)
diff --git a/cmake/googletest.cmake b/cmake/googletest.cmake
index 4983d46c..6908fc52 100644
--- a/cmake/googletest.cmake
+++ b/cmake/googletest.cmake
@@ -26,27 +26,4 @@
 # OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 # OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 
-include(FetchContent)
-
-set(GOOGLETEST_DIR "" CACHE STRING "Location of local GoogleTest repo to build against")
-
-if(GOOGLETEST_DIR)
-  set(FETCHCONTENT_SOURCE_DIR_GOOGLETEST ${GOOGLETEST_DIR} CACHE STRING "GoogleTest source directory override")
-endif()
-
-set(GTEST_REPOSITORY "https://github.com/google/googletest.git" CACHE STRING "GoogleTest repo to fetch")
-FetchContent_Declare(
-  googletest
-  GIT_REPOSITORY ${GTEST_REPOSITORY}
-  GIT_TAG        v1.14.0
-  )
-
-FetchContent_GetProperties(googletest)
-
-if(NOT googletest_POPULATED)
-  FetchContent_Populate(googletest)
-  if (MSVC)
-    set(gtest_force_shared_crt ON CACHE BOOL "" FORCE)
-  endif()
-  add_subdirectory(${googletest_SOURCE_DIR} ${googletest_BINARY_DIR} EXCLUDE_FROM_ALL)
-endif()
+find_package(GTest REQUIRED)
diff --git a/examples/63_hopper_gemm_with_weight_prefetch/CMakeLists.txt b/examples/63_hopper_gemm_with_weight_prefetch/CMakeLists.txt
index 72f59476..0a22d82c 100644
--- a/examples/63_hopper_gemm_with_weight_prefetch/CMakeLists.txt
+++ b/examples/63_hopper_gemm_with_weight_prefetch/CMakeLists.txt
@@ -28,6 +28,9 @@
 
 set(TEST_PREFETCH_CASE --m=8192 --n=64 --k=8192 --iterations=0) 
 
+set(CMAKE_CXX_STANDARD 20)
+set(CMAKE_CUDA_STANDARD 20)
+
 cutlass_example_add_executable(
   63_hopper_gemm_with_weight_prefetch
   63_hopper_gemm_with_weight_prefetch.cu
diff --git a/include/cutlass/platform/platform.h b/include/cutlass/platform/platform.h
index 939451a2..3db980a3 100644
--- a/include/cutlass/platform/platform.h
+++ b/include/cutlass/platform/platform.h
@@ -596,11 +596,11 @@ struct alignment_of<float4> {
   enum { value = 16 };
 };
 template <>
-struct alignment_of<long4> {
+struct alignment_of<long4_32a> {
   enum { value = 16 };
 };
 template <>
-struct alignment_of<ulong4> {
+struct alignment_of<ulong4_32a> {
   enum { value = 16 };
 };
 template <>
@@ -616,15 +616,15 @@ struct alignment_of<double2> {
   enum { value = 16 };
 };
 template <>
-struct alignment_of<longlong4> {
+struct alignment_of<longlong4_32a> {
   enum { value = 16 };
 };
 template <>
-struct alignment_of<ulonglong4> {
+struct alignment_of<ulonglong4_32a> {
   enum { value = 16 };
 };
 template <>
-struct alignment_of<double4> {
+struct alignment_of<double4_32a> {
   enum { value = 16 };
 };
 
diff --git a/python/cutlass/emit/pytorch.py b/python/cutlass/emit/pytorch.py
index e759596c..ca5911e5 100644
--- a/python/cutlass/emit/pytorch.py
+++ b/python/cutlass/emit/pytorch.py
@@ -767,11 +767,6 @@ def _pytorch_gemm(op, name: str, cc: int, jit: bool = False, sourcedir: str = ""
     with open(cpp_file, "w") as outfile:
         outfile.write(cpp_source)
 
-    extra_compile_args = ""
-    if cc == 90:
-        extra_compile_args = "'--generate-code=arch=compute_90a,code=[sm_90a]'"
-    _generate_setup(name, sourcedir, extra_compile_args)
-
     if jit:
         return _jit(name, cc, cpp_file, cuda_file)
 
-- 
2.34.1

